<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DriveEase Rentals</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0b3d91;
            --accent-orange: #ff7b00;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
        }
        .navbar {
            background-color: var(--primary-blue);
        }
        .navbar-brand {
            font-weight: bold;
        }
        .sidebar {
            height: 100vh;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            padding-top: 20px;
        }
        .nav-pills .nav-link {
            color: #333;
            border-radius: 0;
            padding: 15px 20px;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-blue);
            color: #fff;
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #f8f9fa;
        }
        .content-area {
            padding: 30px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .table th {
            border-top: none;
            color: #666;
        }
        .btn-action {
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        .modal-header {
            background-color: var(--primary-blue);
            color: #fff;
        }
        .close {
            color: #fff;
        }
        .vehicle-img-thumb {
            width: 50px;
            height: 30px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand" href="#"><i class="fa fa-car-side"></i> DriveEase Admin</a>
    <div class="ml-auto">
        <form th:action="@{/logout}" method="post" class="d-inline">
            <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar px-0">
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="v-pills-users-tab" data-toggle="pill" href="#v-pills-users" role="tab" aria-controls="v-pills-users" aria-selected="true"><i class="fa fa-users mr-2"></i> Users</a>
                <a class="nav-link" id="v-pills-vehicles-tab" data-toggle="pill" href="#v-pills-vehicles" role="tab" aria-controls="v-pills-vehicles" aria-selected="false"><i class="fa fa-car mr-2"></i> Vehicles</a>
            </div>
        </div>
        <div class="col-md-10 content-area">
            <div class="tab-content" id="v-pills-tabContent">
                
                <!-- Users Section -->
                <div class="tab-pane fade show active" id="v-pills-users" role="tabpanel" aria-labelledby="v-pills-users-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>User Management</h3>
                        <button class="btn btn-sm btn-primary" onclick="fetchUsers()"><i class="fa fa-sync"></i> Refresh</button>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vehicles Section -->
                <div class="tab-pane fade" id="v-pills-vehicles" role="tabpanel" aria-labelledby="v-pills-vehicles-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Vehicle Management</h3>
                        <button class="btn btn-success" data-toggle="modal" data-target="#vehicleModal" onclick="resetVehicleForm()"><i class="fa fa-plus"></i> Add Vehicle</button>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Brand</th>
                                        <th>Model</th>
                                        <th>Year</th>
                                        <th>License Plate</th>
                                        <th>Daily Price</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Image</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vehiclesTableBody">
                                    <!-- Vehicles will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" role="dialog" aria-labelledby="vehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleModalLabel">Add/Edit Vehicle</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="vehicleForm">
                    <input type="hidden" id="vehicleId">
                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" class="form-control" id="brand" name="brand" required>
                    </div>
                    <div class="form-group">
                        <label for="model">Model</label>
                        <input type="text" class="form-control" id="model" name="model" required>
                    </div>
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="number" class="form-control" id="year" name="year" required min="1900">
                    </div>
                    <div class="form-group">
                        <label for="licensePlate">License Plate</label>
                        <input type="text" class="form-control" id="licensePlate" name="licensePlate" required>
                    </div>
                    <div class="form-group">
                        <label for="dailyPrice">Daily Price</label>
                        <input type="number" class="form-control" id="dailyPrice" name="dailyPrice" required min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select class="form-control" id="type" name="type" required>
                            <option value="Sedan">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="Bike">Bike</option>
                            <option value="Truck">Truck</option>
                            <option value="Luxury">Luxury</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="AVAILABLE">Available</option>
                            <option value="RENTED">Rented</option>
                            <option value="MAINTENANCE">Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="image">Vehicle Image</label>
                        <input type="file" class="form-control-file" id="image" name="image">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveVehicle()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
    const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

    const jsonHeaders = {
        'Content-Type': 'application/json',
        [csrfHeader]: csrfToken
    };

    $(document).ready(function() {
        fetchUsers();
        fetchVehicles();
    });

    // --- User Management ---

    function fetchUsers() {
        fetch('/admin/users')
            .then(response => response.json())
            .then(users => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="badge badge-${user.role === 'ADMIN' ? 'danger' : 'info'}">${user.role || 'USER'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning btn-action" onclick="toggleRole(${user.id}, '${user.role}')">
                                    ${user.role === 'ADMIN' ? 'Demote' : 'Promote'}
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser(${user.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    function toggleRole(id, currentRole) {
        const newRole = currentRole === 'ADMIN' ? 'USER' : 'ADMIN';
        fetch(`/admin/users/${id}/role`, {
            method: 'PUT',
            headers: jsonHeaders,
            body: JSON.stringify({ role: newRole })
        }).then(() => fetchUsers());
    }

    function deleteUser(id) {
        if(confirm('Are you sure you want to delete this user?')) {
            fetch(`/admin/users/${id}`, {
                method: 'DELETE',
                headers: jsonHeaders
            }).then(() => fetchUsers());
        }
    }

    // --- Vehicle Management ---

    function fetchVehicles() {
        fetch('/admin/vehicles')
            .then(response => response.json())
            .then(vehicles => {
                const tbody = document.getElementById('vehiclesTableBody');
                tbody.innerHTML = '';
                vehicles.forEach(vehicle => {
                    let statusBadge = 'secondary';
                    if (vehicle.status === 'AVAILABLE') statusBadge = 'success';
                    else if (vehicle.status === 'RENTED') statusBadge = 'warning';
                    else if (vehicle.status === 'MAINTENANCE') statusBadge = 'danger';

                    const row = `
                        <tr>
                            <td>${vehicle.id}</td>
                            <td>${vehicle.brand}</td>
                            <td>${vehicle.model}</td>
                            <td>${vehicle.year}</td>
                            <td>${vehicle.licensePlate}</td>
                            <td>$${vehicle.dailyPrice}</td>
                            <td>${vehicle.type}</td>
                            <td><span class="badge badge-${statusBadge}">${vehicle.status}</span></td>
                            <td>${vehicle.imageUrl ? `<img src="${vehicle.imageUrl}" class="vehicle-img-thumb">` : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary btn-action" onclick='editVehicle(${JSON.stringify(vehicle)})'>Edit</button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteVehicle(${vehicle.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    function resetVehicleForm() {
        document.getElementById('vehicleForm').reset();
        document.getElementById('vehicleId').value = '';
        document.getElementById('vehicleModalLabel').innerText = 'Add Vehicle';
    }

    function editVehicle(vehicle) {
        document.getElementById('vehicleId').value = vehicle.id;
        document.getElementById('brand').value = vehicle.brand;
        document.getElementById('model').value = vehicle.model;
        document.getElementById('year').value = vehicle.year;
        document.getElementById('licensePlate').value = vehicle.licensePlate;
        document.getElementById('dailyPrice').value = vehicle.dailyPrice;
        document.getElementById('type').value = vehicle.type;
        document.getElementById('status').value = vehicle.status;
        
        document.getElementById('vehicleModalLabel').innerText = 'Edit Vehicle';
        $('#vehicleModal').modal('show');
    }

    function saveVehicle() {
        const id = document.getElementById('vehicleId').value;
        const formData = new FormData(document.getElementById('vehicleForm'));
        
        // Append ID if updating, though usually ID is in path
        if(id) formData.append('id', id);

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/admin/vehicles/${id}` : '/admin/vehicles';

        fetch(url, {
            method: method,
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        }).then(response => {
            if(response.ok) {
                $('#vehicleModal').modal('hide');
                fetchVehicles();
            } else {
                alert('Error saving vehicle');
            }
        });
    }

    function deleteVehicle(id) {
        if(confirm('Are you sure you want to delete this vehicle?')) {
            fetch(`/admin/vehicles/${id}`, {
                method: 'DELETE',
                headers: jsonHeaders
            }).then(async response => {
                if (response.ok) {
                    fetchVehicles();
                } else {
                    const msg = await response.text();
                    alert('Error deleting vehicle: ' + msg);
                }
            });
        }
    }
</script>

</body>
</html>
