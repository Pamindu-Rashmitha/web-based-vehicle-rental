<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DriveEase Rentals</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0b3d91;
            --accent-orange: #ff7b00;
            --gradient-start: #1e3c72;
            --gradient-end: #2a5298;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .navbar {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 700;
            color: white;
            font-size: 1.5rem;
        }
        .navbar-brand i {
            margin-right: 8px;
            color: var(--accent-orange);
        }
        .sidebar {
            height: 100vh;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            padding-top: 20px;
        }
        .nav-pills .nav-link {
            color: #333;
            border-radius: 0;
            padding: 15px 20px;
        }
        .nav-pills .nav-link.active {
            background-color: var(--accent-orange);
            color: #fff;
        }
        .nav-pills .nav-link:hover:not(.active) {
            background-color: #f8f9fa;
        }
        .content-area {
            padding: 30px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .table th {
            border-top: none;
            color: #666;
        }
        .btn-action {
            padding: 2px 8px;
            font-size: 0.8rem;
        }
        .modal-header {
            background-color: var(--primary-blue);
            color: #fff;
        }
        .close {
            color: #fff;
        }
        .vehicle-img-thumb {
            width: 50px;
            height: 30px;
            object-fit: cover;
            border-radius: 4px;
        }
        /* Global button theme overrides */
        .btn-primary {
            background-color: var(--accent-orange);
            border-color: var(--accent-orange);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #ff6500;
            border-color: #ff6500;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 123, 0, 0.3);
            color: white;
        }
        .btn-primary:focus,
        .btn-primary:active {
            background-color: #ff6500;
            border-color: #ff6500;
            color: white;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand" href="#">
        <i class="fa fa-car-side"></i>DriveEase Admin
    </a>
    <div class="ml-auto">
        <form th:action="@{/logout}" method="post" class="d-inline">
            <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
        </form>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar px-0">
            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <a class="nav-link active" id="v-pills-users-tab" data-toggle="pill" href="#v-pills-users" role="tab" aria-controls="v-pills-users" aria-selected="true"><i class="fa fa-users mr-2"></i> Users</a>
                <a class="nav-link" id="v-pills-vehicles-tab" data-toggle="pill" href="#v-pills-vehicles" role="tab" aria-controls="v-pills-vehicles" aria-selected="false"><i class="fa fa-car mr-2"></i> Vehicles</a>
                <a class="nav-link" id="v-pills-reservations-tab" data-toggle="pill" href="#v-pills-reservations" role="tab" aria-controls="v-pills-reservations" aria-selected="false"><i class="fa fa-calendar-alt mr-2"></i> Reservations</a>
                <a class="nav-link" id="v-pills-reports-tab" data-toggle="pill" href="#v-pills-reports" role="tab" aria-controls="v-pills-reports" aria-selected="false"><i class="fa fa-chart-line mr-2"></i> Reports</a>
                <a class="nav-link" id="v-pills-payments-tab" data-toggle="pill" href="#v-pills-payments" role="tab" aria-controls="v-pills-payments" aria-selected="false"><i class="fa fa-dollar-sign mr-2"></i> Payments</a>
                <a class="nav-link" id="v-pills-support-tab" data-toggle="pill" href="#v-pills-support" role="tab" aria-controls="v-pills-support" aria-selected="false"><i class="fa fa-headset mr-2"></i> Support Tickets</a>
            </div>
        </div>
        <div class="col-md-10 content-area">
            <div class="tab-content" id="v-pills-tabContent">
                
                <!-- Users Section -->
                <div class="tab-pane fade show active" id="v-pills-users" role="tabpanel" aria-labelledby="v-pills-users-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>User Management</h3>
                        <button class="btn btn-sm btn-primary" onclick="fetchUsers()"><i class="fa fa-sync"></i> Refresh</button>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Vehicles Section -->
                <div class="tab-pane fade" id="v-pills-vehicles" role="tabpanel" aria-labelledby="v-pills-vehicles-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Vehicle Management</h3>
                        <button class="btn btn-success" data-toggle="modal" data-target="#vehicleModal" onclick="resetVehicleForm()"><i class="fa fa-plus"></i> Add Vehicle</button>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Brand</th>
                                        <th>Model</th>
                                        <th>Year</th>
                                        <th>License Plate</th>
                                        <th>Daily Price</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Image</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vehiclesTableBody">
                                    <!-- Vehicles will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reservations Section -->
                <div class="tab-pane fade" id="v-pills-reservations" role="tabpanel" aria-labelledby="v-pills-reservations-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Reservation Management</h3>
                        <button class="btn btn-sm btn-primary" onclick="fetchReservations()"><i class="fa fa-sync"></i> Refresh</button>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Vehicle</th>
                                        <th>Dates</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="reservationsTableBody">
                                    <!-- Reservations will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div class="tab-pane fade" id="v-pills-reports" role="tabpanel" aria-labelledby="v-pills-reports-tab">
                    <h3 class="mb-4">Reports & Analytics</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white font-weight-bold">Monthly Income</div>
                                <div class="card-body">
                                    <canvas id="incomeChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white font-weight-bold">Most Popular Vehicles</div>
                                <div class="card-body">
                                    <canvas id="popularityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-danger text-white font-weight-bold">
                            <i class="fa fa-exclamation-triangle mr-2"></i> Overdue Alerts
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Reservation ID</th>
                                        <th>User</th>
                                        <th>Vehicle</th>
                                        <th>End Date</th>
                                        <th>Total Price</th>
                                    </tr>
                                </thead>
                                <tbody id="overdueTableBody">
                                    <!-- Overdue items loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div class="tab-pane fade" id="v-pills-payments" role="tabpanel" aria-labelledby="v-pills-payments-tab">
                    <h3 class="mb-4">Payment Management</h3>
                    
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h6 class="card-title">Total Revenue</h6>
                                    <h3 class="mb-0" id="totalRevenue">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h6 class="card-title">Total Refunds</h6>
                                    <h3 class="mb-0" id="totalRefunds">$0.00</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-info">
                                <div class="card-body">
                                    <h6 class="card-title">Pending Payments</h6>
                                    <h3 class="mb-0" id="pendingPayments">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payments Table -->
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Reservation</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Refund</th>
                                        <th>Stripe ID</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody">
                                    <!-- Payments will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Support Tickets Section -->
                <div class="tab-pane fade" id="v-pills-support" role="tabpanel" aria-labelledby="v-pills-support-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Support Ticket Management</h3>
                        <button class="btn btn-sm btn-primary" onclick="fetchSupportTickets()"><i class="fa fa-sync"></i> Refresh</button>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Category</th>
                                        <th>Subject</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Screenshot</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="supportTicketsTableBody">
                                    <!-- Support tickets will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Vehicle Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1" role="dialog" aria-labelledby="vehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleModalLabel">Add/Edit Vehicle</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="vehicleForm">
                    <input type="hidden" id="vehicleId">
                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" class="form-control" id="brand" name="brand" required>
                    </div>
                    <div class="form-group">
                        <label for="model">Model</label>
                        <input type="text" class="form-control" id="model" name="model" required>
                    </div>
                    <div class="form-group">
                        <label for="year">Year</label>
                        <input type="number" class="form-control" id="year" name="year" required min="1900">
                    </div>
                    <div class="form-group">
                        <label for="licensePlate">License Plate</label>
                        <input type="text" class="form-control" id="licensePlate" name="licensePlate" required>
                    </div>
                    <div class="form-group">
                        <label for="dailyPrice">Daily Price</label>
                        <input type="number" class="form-control" id="dailyPrice" name="dailyPrice" required min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select class="form-control" id="type" name="type" required>
                            <option value="Sedan">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="Bike">Bike</option>
                            <option value="Truck">Truck</option>
                            <option value="Luxury">Luxury</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="AVAILABLE">Available</option>
                            <option value="RENTED">Rented</option>
                            <option value="MAINTENANCE">Maintenance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="image">Vehicle Image</label>
                        <input type="file" class="form-control-file" id="image" name="image">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveVehicle()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
    const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

    const jsonHeaders = {
        'Content-Type': 'application/json',
        [csrfHeader]: csrfToken
    };

    $(document).ready(function() {
        fetchUsers();
        fetchVehicles();
        
        // Load reports when tab is shown
        $('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'v-pills-reports-tab') {
                loadReports();
            } else if (e.target.id === 'v-pills-reservations-tab') {
                fetchReservations();
            } else if (e.target.id === 'v-pills-payments-tab') {
                loadPayments();
                loadPaymentStats();
            } else if (e.target.id === 'v-pills-support-tab') {
                fetchSupportTickets();
            }
        });
    });

    // --- User Management ---

    function fetchUsers() {
        fetch('/admin/users')
            .then(response => response.json())
            .then(users => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                users.forEach(user => {
                    const row = `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="badge badge-${user.role === 'ADMIN' ? 'danger' : 'info'}">${user.role || 'USER'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning btn-action" onclick="toggleRole(${user.id}, '${user.role}')">
                                    ${user.role === 'ADMIN' ? 'Demote' : 'Promote'}
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser(${user.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    function toggleRole(id, currentRole) {
        const newRole = currentRole === 'ADMIN' ? 'USER' : 'ADMIN';
        fetch(`/admin/users/${id}/role`, {
            method: 'PUT',
            headers: jsonHeaders,
            body: JSON.stringify({ role: newRole })
        }).then(() => fetchUsers());
    }

    function deleteUser(id) {
        if(confirm('Are you sure you want to delete this user?')) {
            fetch(`/admin/users/${id}`, {
                method: 'DELETE',
                headers: jsonHeaders
            }).then(() => fetchUsers());
        }
    }

    // --- Vehicle Management ---

    function fetchVehicles() {
        fetch('/admin/vehicles')
            .then(response => response.json())
            .then(vehicles => {
                const tbody = document.getElementById('vehiclesTableBody');
                tbody.innerHTML = '';
                vehicles.forEach(vehicle => {
                    let statusBadge = 'secondary';
                    if (vehicle.status === 'AVAILABLE') statusBadge = 'success';
                    else if (vehicle.status === 'RENTED') statusBadge = 'warning';
                    else if (vehicle.status === 'MAINTENANCE') statusBadge = 'danger';

                    const row = `
                        <tr>
                            <td>${vehicle.id}</td>
                            <td>${vehicle.brand}</td>
                            <td>${vehicle.model}</td>
                            <td>${vehicle.year}</td>
                            <td>${vehicle.licensePlate}</td>
                            <td>$${vehicle.dailyPrice}</td>
                            <td>${vehicle.type}</td>
                            <td><span class="badge badge-${statusBadge}">${vehicle.status}</span></td>
                            <td>${vehicle.imageUrl ? `<img src="${vehicle.imageUrl}" class="vehicle-img-thumb">` : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary btn-action" onclick='editVehicle(${JSON.stringify(vehicle)})'>Edit</button>
                                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteVehicle(${vehicle.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    function resetVehicleForm() {
        document.getElementById('vehicleForm').reset();
        document.getElementById('vehicleId').value = '';
        document.getElementById('vehicleModalLabel').innerText = 'Add Vehicle';
    }

    function editVehicle(vehicle) {
        document.getElementById('vehicleId').value = vehicle.id;
        document.getElementById('brand').value = vehicle.brand;
        document.getElementById('model').value = vehicle.model;
        document.getElementById('year').value = vehicle.year;
        document.getElementById('licensePlate').value = vehicle.licensePlate;
        document.getElementById('dailyPrice').value = vehicle.dailyPrice;
        document.getElementById('type').value = vehicle.type;
        document.getElementById('status').value = vehicle.status;
        
        document.getElementById('vehicleModalLabel').innerText = 'Edit Vehicle';
        $('#vehicleModal').modal('show');
    }

    function saveVehicle() {
        const id = document.getElementById('vehicleId').value;
        const formData = new FormData(document.getElementById('vehicleForm'));
        
        // Append ID if updating, though usually ID is in path
        if(id) formData.append('id', id);

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/admin/vehicles/${id}` : '/admin/vehicles';

        fetch(url, {
            method: method,
            headers: {
                [csrfHeader]: csrfToken
            },
            body: formData
        }).then(response => {
            if(response.ok) {
                $('#vehicleModal').modal('hide');
                fetchVehicles();
            } else {
                alert('Error saving vehicle');
            }
        });
    }

    function deleteVehicle(id) {
        if(confirm('Are you sure you want to delete this vehicle?')) {
            fetch(`/admin/vehicles/${id}`, {
                method: 'DELETE',
                headers: jsonHeaders
            }).then(async response => {
                if (response.ok) {
                    fetchVehicles();
                } else {
                    const msg = await response.text();
                    alert('Error deleting vehicle: ' + msg);
                }
            });
        }
    }

    // --- Reservation Management ---

    function fetchReservations() {
        fetch('/admin/reservations')
            .then(response => response.json())
            .then(reservations => {
                const tbody = document.getElementById('reservationsTableBody');
                tbody.innerHTML = '';
                reservations.forEach(r => {
                    let statusBadge = 'secondary';
                    if (r.status === 'CONFIRMED') statusBadge = 'success';
                    else if (r.status === 'PENDING') statusBadge = 'warning';
                    else if (r.status === 'CANCELLED') statusBadge = 'danger';
                    else if (r.status === 'COMPLETED') statusBadge = 'info';

                    const row = `
                        <tr>
                            <td>${r.id}</td>
                            <td>${r.user.username}</td>
                            <td>${r.vehicle.brand} ${r.vehicle.model}</td>
                            <td>${r.startDate} to ${r.endDate}</td>
                            <td>$${r.totalPrice}</td>
                            <td><span class="badge badge-${statusBadge}">${r.status}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // --- Reports ---
    let incomeChart = null;
    let popularityChart = null;

    function loadReports() {
        loadIncomeChart();
        loadPopularityChart();
        loadOverdueTable();
    }

    function loadIncomeChart() {
        fetch('/admin/reports/income')
            .then(res => res.json())
            .then(data => {
                const labels = data.map(item => `${item[0]}-${item[1]}`); // Year-Month
                const values = data.map(item => item[2]); // Total

                const ctx = document.getElementById('incomeChart').getContext('2d');
                if (incomeChart) incomeChart.destroy();
                
                incomeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue ($)',
                            data: values,
                            backgroundColor: 'rgba(11, 61, 145, 0.7)',
                            borderColor: 'rgba(11, 61, 145, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            });
    }

    function loadPopularityChart() {
        fetch('/admin/reports/popularity')
            .then(res => res.json())
            .then(data => {
                const labels = data.map(item => `${item[0].brand} ${item[0].model}`);
                const values = data.map(item => item[1]); // Count

                const ctx = document.getElementById('popularityChart').getContext('2d');
                if (popularityChart) popularityChart.destroy();

                popularityChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                            ]
                        }]
                    }
                });
            });
    }

    function loadOverdueTable() {
        fetch('/admin/reports/overdue')
            .then(res => res.json())
            .then(reservations => {
                const tbody = document.getElementById('overdueTableBody');
                tbody.innerHTML = '';
                if (reservations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No overdue reservations.</td></tr>';
                    return;
                }
                reservations.forEach(r => {
                    const row = `
                        <tr>
                            <td>${r.id}</td>
                            <td>${r.user.username}</td>
                            <td>${r.vehicle.brand} ${r.vehicle.model}</td>
                            <td class="text-danger font-weight-bold">${r.endDate}</td>
                            <td>$${r.totalPrice}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    // --- Payment Management ---

    function loadPayments() {
        fetch('/admin/payments')
            .then(res => res.json())
            .then(payments => {
                const tbody = document.getElementById('paymentsTableBody');
                tbody.innerHTML = '';
                
                if (payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No payments found.</td></tr>';
                    return;
                }
                
                payments.forEach(p => {
                    let statusBadge = 'secondary';
                    if (p.status === 'SUCCEEDED') statusBadge = 'success';
                    else if (p.status === 'FAILED') statusBadge = 'danger';
                    else if (p.status === 'REFUNDED') statusBadge = 'warning';
                    else if (p.status === 'PENDING') statusBadge = 'info';

                    const row = `
                        <tr>
                            <td>${p.id}</td>
                            <td>#${p.reservation?.id || 'N/A'}</td>
                            <td>$${p.amount.toFixed(2)}</td>
                            <td><span class="badge badge-${statusBadge}">${p.status}</span></td>
                            <td>${p.refundAmount ? '$' + p.refundAmount.toFixed(2) : '-'}</td>
                            <td><small>${p.stripePaymentIntentId || 'Pending'}</small></td>
                            <td>${new Date(p.createdAt).toLocaleDateString()}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }

    function loadPaymentStats() {
        fetch('/admin/payments/stats')
            .then(res => res.json())
            .then(stats => {
                document.getElementById('totalRevenue').innerText = '$' + (stats.totalRevenue || 0).toFixed(2);
                document.getElementById('totalRefunds').innerText = '$' + (stats.totalRefunds || 0).toFixed(2);
                document.getElementById('pendingPayments').innerText = stats.pendingPayments || 0;
            });
    }

    // --- Support Ticket Management ---

    function fetchSupportTickets() {
        fetch('/api/admin/support/requests')
            .then(res => res.json())
            .then(tickets => {
                const tbody = document.getElementById('supportTicketsTableBody');
                tbody.innerHTML = '';
                
                if (tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No support tickets found.</td></tr>';
                    return;
                }
                
                tickets.forEach(ticket => {
                    let statusBadge = 'secondary';
                    if (ticket.status === 'OPEN') statusBadge = 'danger';
                    else if (ticket.status === 'IN_PROGRESS') statusBadge = 'warning';
                    else if (ticket.status === 'RESOLVED') statusBadge = 'success';
                    else if (ticket.status === 'CLOSED') statusBadge = 'info';

                    const screenshotLink = ticket.screenshotUrl 
                        ? `<a href="${ticket.screenshotUrl}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fa fa-image"></i></a>`
                        : '-';

                    const row = `
                        <tr>
                            <td>${ticket.id}</td>
                            <td>${ticket.user.username}</td>
                            <td><span class="badge badge-secondary">${ticket.category}</span></td>
                            <td>${ticket.subject}</td>
                            <td><span class="badge badge-${statusBadge}">${ticket.status.replace('_', ' ')}</span></td>
                            <td>${new Date(ticket.createdAt).toLocaleDateString()}</td>
                            <td>${screenshotLink}</td>
                            <td>
                                <select class="form-control form-control-sm" onchange="updateTicketStatus(${ticket.id}, this.value)">
                                    <option value="">Update Status...</option>
                                    <option value="OPEN" ${ticket.status === 'OPEN' ? 'selected' : ''}>Open</option>
                                    <option value="IN_PROGRESS" ${ticket.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                                    <option value="RESOLVED" ${ticket.status === 'RESOLVED' ? 'selected' : ''}>Resolved</option>
                                    <option value="CLOSED" ${ticket.status === 'CLOSED' ? 'selected' : ''}>Closed</option>
                                </select>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching support tickets:', error);
                alert('Failed to load support tickets');
            });
    }

    function updateTicketStatus(requestId, newStatus) {
        if (!newStatus) return; // User selected placeholder option
        
        if (!confirm(`Update ticket #${requestId} to status: ${newStatus.replace('_', ' ')}?`)) {
            fetchSupportTickets(); // Reload to reset dropdown
            return;
        }

        const formData = new URLSearchParams();
        formData.append('requestId', requestId);
        formData.append('status', newStatus);

        fetch('/api/admin/support/update-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                [csrfHeader]: csrfToken
            },
            body: formData
        })
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                alert('Status updated successfully!');
                fetchSupportTickets(); // Refresh the table
            } else {
                alert('Error: ' + response.message);
                fetchSupportTickets(); // Reload to reset dropdown
            }
        })
        .catch(error => {
            console.error('Error updating ticket status:', error);
            alert('Failed to update ticket status');
            fetchSupportTickets(); // Reload to reset dropdown
        });
    }
</script>

</body>
</html>
